#!/bin/bash

set -e

command="$1"
target="$2"

export PROJECT_PATH="`pwd`"
export EFILE="$PROJECT_PATH/build/tmp/jackbone.out"
cd `dirname "$0"`
export JACKBONEGAP_PATH="`pwd`"

function error() {
    test -e "$EFILE" && cat "$EFILE"
    echo
    echo -e "[ERROR] \033[1m\033[31m$1\033[0m"
    test "x$2" != "x" && echo -e "        \033[31m$2\033[0m"
    test "x$3" != "x" && echo -e "        \033[31m$3\033[0m"
    echo
    exit  1
}

function usage {
    echo "usage: $0 <command>"
    echo "commands:"
    echo
    echo "- boilerplate  Create a new project."
    echo "- init         Download dependencies."
    echo "- update       Update dependencies."
    echo "- build        Compile your project."
    echo "- run          Execute your app."
    echo "- archive      TODO."
    echo "- clean        Delete generated files."
    echo "- upload       TODO."
    echo "- version      Manage your version number."
    echo "- help         Show this help message."
    echo
    echo "Type '$0 <command> help' for more help on a specific command"
    echo
    exit 1
}

function checkNeededFiles() {
    test -e "$PROJECT_PATH/config" || error "config file is missing, create one from config-sample."
    test -e "$PROJECT_PATH/assets/Default.png" || error "assets/Default.png is missing (should be a 2048x2048 image)."
    test -e "$PROJECT_PATH/assets/Icon.png" || error "assets/Icon.png is missing (should be a 2048x2048 image)."
    n=`ls -1 "$PROJECT_PATH/app/html/" | wc -l`
    [ $n -gt 0 ] || error "Please add your handlebars templates into app/html (at least one is needed)"
}

script="scripts/$command.sh"
test -e "$script" || usage

export DOWNLOADS_PATH="$PROJECT_PATH/.downloads"
export LIBS_PATH="$PROJECT_PATH/libs"
export JS_LIBS_PATH="$PROJECT_PATH/app/js/libs"

if [ "x$command" != xboilerplate ]; then
    checkNeededFiles
    . "$PROJECT_PATH/config"

    if [ "x$PROJECT_NAME" = "x" ]; then
        error "config file should specify a project name."
    fi
fi

. "$script" $@ || exit 1
